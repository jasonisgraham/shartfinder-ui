<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="combatant-card.html">
<link rel="import" href="combatant-service.html">
<link rel="import" href="x-websocket.html">
<link rel="import" href="add-combatant.html">

<polymer-element name="combatant-list" attributes="combatants showView show user">
  <template>
    <style>
    :host {
      display: block;
      width: 100%;
    }
    combatant-card {
      margin-top: 30px;
    }
    </style>
	
	<combatant-service id="service" combatants="{{combatants}}">
	</combatant-service>

	
	<div layout vertical center>
	
	  <add-combatant on-combatant-add="{{addCombatant}}" hidden?="{{!show || showView != 'add-combatant'}}"></add-combatant>

	  <template repeat="{{combatant in combatants}}">
		<combatant-card 
		selected="{{combatant.selected}}"
		  showView="{{showView}}"
		  user="{{user}}"
		  combatantName="{{combatant.combatantName}}"
		  mine="{{combatant.mine}}"
		  hidden?="{{!show || (showView == 'initiative' && !combatant.mine)}}">
		  {{combatant.combatantName}}
		</combatant-card>
	  </template>

	</div>
	
  </template>

  <script>
  Polymer({
   publish: {
		show: {
			value: false,
			reflect: true
		},
		showView: {
			value: "add-combatant",
			reflect: true
		}
	  },
	addCombatant: function(event, detail, sender) {
		var addCombatantName = sender.addCombatantName;
		var containsKey = false;
		for (var key in this.combatants) {
			if (this.combatants[key].combatantName === addCombatantName) {
				containsKey = true;
				break;
			}
		}
		if (!containsKey){
			var addCombatantData = { data: { combatantName: addCombatantName, user: this.user }, eventName: "add-combatant" };
			var xws = document.querySelector("x-websocket");
			xws.send(addCombatantData);
		}
		sender.addCombatantName = '';
	  }
	});
  </script>

</polymer-element>
