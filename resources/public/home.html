<!doctype html>
<html>

<head>

	<title>Shartfinder</title>

	<meta name="viewport" 
	content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

	<script src="components/webcomponentsjs/webcomponents.js">
	</script>

	<link rel="import" href="combatant-list.html">
	<link rel="import" href="log-in.html">
	<link rel="import" href="start-encounter.html">
	<link rel="import" href="x-websocket.html">
	
	<style>
		html,body {
			height: 100%;
			margin: 0;
			background-color: #E5E5E5;
			font-family: sans-serif;
		}
		.container {
			width: 80%;
			margin: 50px auto;
		}
		@media (min-width: 481px) {
			.container {
				width: 200px;
			}
		}
	</style>

</head>

<body unresolved>
	
	<div class="container" layout vertical center>
	
	<log-in></log-in>

	<x-websocket json></x-websocket>
	
	<start-encounter></start-encounter>
		
		<combatant-list></combatant-list>
	</div>
	
	<script>
	window.addEventListener('polymer-ready', function(e) {
			var xws = document.querySelector("x-websocket");
			var li = document.querySelector("log-in");
			var cl = document.querySelector("combatant-list");
			var se = document.querySelector("start-encounter");
			li.addEventListener('logged-in', function(){
				li.show = false;
				cl.show = true;
				cl.user = li.user;
				se.show = true;
			});
			xws.addEventListener("message", function(event) {
				console.log("message", event.detail.data);
				  var eventName = event.detail.data.eventName;
				  var payload = event.detail.data.payload;
				 var isMine = payload.user === li.user;
					if (eventName === "add-combatant"){
					  var containsKey = false;
						for (var key in cl.combatants) {
							if (cl.combatants[key].combatantName === payload.combatantName){
								cl.combatants[key].selected = true;
								if (isMine){
									cl.combatants[key].mine = true;
								}
								containsKey = true;
								break;
							}
						} 
						if (!containsKey){
							var key = cl.combatants.push(payload) - 1;
							cl.combatants[key].selected = true;
							if (isMine){
								cl.combatants[key].mine = true;
							}
						}
					} 
					if (eventName === "start-encounter"){
						se.show = false;
						cl.showView = 'initiative';
					} 
					if (eventName === "initiative-created"){
						cl.combatants = [];
						for (var key in payload.orderedCombatants) {
							cl.combatants.push(payload.orderedCombatants[key]);
						} 
						cl.showView = 'round-started';
					}
					if (eventName === "roll-initiative"){
						for (var key in cl.combatants) {
							if (cl.combatants[key].combatantName === payload.combatantName){
								if (isMine){
									cl.combatants[key].submitted = true;
								}
								break;
							}
						}
					}
			});
		});
	</script>

</body>

</html>
