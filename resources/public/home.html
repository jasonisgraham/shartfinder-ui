<!doctype html>
<html>

<head>

	<title>Shartfinder</title>

	<meta name="viewport" 
	content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

	<script src="components/webcomponentsjs/webcomponents.js">
	</script>

	<link rel="import" href="combatant-list.html">
	<link rel="import" href="log-in.html">
	<link rel="import" href="x-websocket.html">
	<link rel="import" href="routes.html">
	
	<style>
		html,body {
			height: 100%;
			margin: 0;
			background-color: #E5E5E5;
			font-family: sans-serif;
		}
		.container {
			width: 80%;
			margin: 50px auto;
		}
		@media (min-width: 481px) {
			.container {
				width: 200px;
			}
		}
	</style>

</head>

<body unresolved>
	
	<div class="container" layout vertical center>
	
		<x-websocket json></x-websocket>
		<combatant-service></combatant-service>
		
		<log-in></log-in>	
		<combatant-list></combatant-list>
	</div>
	
	<script>
	window.addEventListener('polymer-ready', function(e) {
			var xWebSocket = document.querySelector("x-websocket");
			var logIn = document.querySelector("log-in");
			var combatantList = document.querySelector("combatant-list");
			logIn.addEventListener('logged-in', function(){
				logIn.show = false;
				combatantList.user = logIn.user;
				var getEncounterData = { eventName: "get-encounter-data" };
				xWebSocket.send(getEncounterData);
			});
			xWebSocket.addEventListener("message", function(event) {
				if (logIn.user){
					console.log("message", event.detail.data);
				    var payload = JSON.parse(event.detail.data.payload);
					var encounterPhase = payload.encounterPhase;
					if (!encounterPhase){
						encounterPhase = 'combatant';
					}

					var combatants = payload.combatants;
					var initiativeRolls = payload.initiativeRolls;
					for (var combatantKey in combatants) {
						for (var initiativeRollKey in initiativeRolls) {
							if (initiativeRolls[initiativeRollKey].combatantName === combatants[combatantKey].combatantName){
								combatants[combatantKey].initiativeSubmitted = true;
							}
						} 
					} 
					
					combatantList.encounterPhase = encounterPhase;
					combatantList.combatants = combatants;
				}
			});
		});
	</script>

</body>

</html>
